trigger:
  branches:
    include:
      - Dev

pool:
  vmImage: 'ubuntu-latest'

steps:
  # 1️⃣ Install Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  # 2️⃣ Install dependencies inside auto_wabp
  - script: |
      cd auto_wabp
      npm ci
    displayName: 'Install dependencies'

  # 3️⃣ Run all Cypress tests
  - script: |
      cd auto_wabp
      export CHROME_FLAGS="--no-sandbox --disable-dev-shm-usage"
      npx cypress run --browser chrome --headless
    displayName: 'Run Cypress Tests'

  # 4️⃣ Debug folder structure
  - script: |
      echo "=== Listing auto_wabp folder ==="
      cd auto_wabp
      ls -R .
    displayName: 'Debug Folder Structure'

  # 5️⃣ Publish test results
  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: 'auto_wabp/results/*.xml'
      mergeTestResults: true
      testRunTitle: 'Cypress Tests'

  # 6️⃣ Publish screenshots
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: 'auto_wabp/cypress/screenshots'
      ArtifactName: 'screenshots'
      publishLocation: 'Container'

  # 7️⃣ Publish videos
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: 'auto_wabp/cypress/videos'
      ArtifactName: 'videos'
      publishLocation: 'Container'
