trigger:
  branches:
    include:
      - Dev

pool:
  vmImage: 'ubuntu-latest'

variables:
  CYPRESS_VIDEO: true
  CYPRESS_SCREENSHOT_ON_FAILURE: true

steps:
  # 1️⃣ Checkout code including submodules
  - checkout: self
    submodules: true
    clean: true

  # 2️⃣ Install Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  # 3️⃣ Install dependencies
  - script: npm ci
    displayName: 'Install dependencies'
    workingDirectory: '$(System.DefaultWorkingDirectory)'

  # 4️⃣ Ensure mocha-junit-reporter is installed
  - script: npm install --no-save mocha-junit-reporter
    displayName: 'Ensure mocha-junit-reporter is installed'
    workingDirectory: '$(System.DefaultWorkingDirectory)'

  # 5️⃣ Run all Cypress tests
  - script: |
      export CHROME_FLAGS="--no-sandbox --disable-dev-shm-usage"
      echo "Running all Cypress tests..."
      npx cypress run \
        --browser chrome \
        --headless \
        --reporter mocha-junit-reporter \
        --reporter-options "mochaFile=results/cypress-[hash].xml,toConsole=true"
    displayName: 'Run all Cypress Tests'
    workingDirectory: '$(System.DefaultWorkingDirectory)'

  # 6️⃣ Debug folder structure (optional)
  - script: |
      echo "=== Listing Cypress folder ==="
      ls -R cypress || echo "cypress folder not found"
      echo "=== Listing results folder ==="
      ls -R results || echo "results folder not found"
    displayName: 'Debug Cypress output'
    workingDirectory: '$(System.DefaultWorkingDirectory)'

  # 7️⃣ Publish JUnit test results
  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: 'results/*.xml'
      mergeTestResults: true
      testRunTitle: 'Cypress Tests'

  # 8️⃣ Publish screenshots
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: 'cypress/screenshots'
      ArtifactName: 'screenshots'
      publishLocation: 'Container'

  # 9️⃣ Publish videos
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: 'cypress/videos'
      ArtifactName: 'videos'
      publishLocation: 'Container'
