trigger:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'

steps:
  # 1️⃣ Install Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  # 2️⃣ Install dependencies
  - script: npm ci
    displayName: 'Install dependencies'

  # 3️⃣ Run Cypress specs sequentially by folder
  - script: |
      export CHROME_FLAGS="--no-sandbox --disable-dev-shm-usage"

      echo "Running Login tests..."
      npx cypress run \
        --browser chrome \
        --headless \
        --spec "cypress/e2e/login/*.cy.js" \
        --reporter spec \
        --reporter-options "mochaFile=results/login-[hash].xml,toConsole=true"

      echo "Running Agent tests..."
      npx cypress run \
        --browser chrome \
        --headless \
        --spec "cypress/e2e/agents/*.cy.js" \
        --reporter spec \
        --reporter-options "mochaFile=results/agents-[hash].xml,toConsole=true"

      echo "Running Campaign tests..."
      npx cypress run \
        --browser chrome \
        --headless \
        --spec "cypress/e2e/campaign/*.cy.js" \
        --reporter spec \
        --reporter-options "mochaFile=results/campaign-[hash].xml,toConsole=true"
    displayName: 'Run Cypress Tests Sequentially'

  # 4️⃣ Debug folder structure (optional)
  - script: |
      echo "=== Listing Cypress folder ==="
      ls -R cypress || echo "cypress folder not found"
      echo "=== Listing results folder ==="
      ls -R results || echo "results folder not found"
    displayName: 'Debug Cypress output'

  # 5️⃣ Publish JUnit test results to Tests tab
  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: 'results/*.xml'
      mergeTestResults: true
      testRunTitle: 'Cypress Tests'

  # 6️⃣ Publish screenshots
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: 'cypress/screenshots'
      ArtifactName: 'screenshots'
      publishLocation: 'Container'

  # 7️⃣ Publish videos
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: 'cypress/videos'
      ArtifactName: 'videos'
      publishLocation: 'Container'
